{% extends "base.html" %}
{% block title %}ğŸ“… Pemeliharaan Alat Kesehatan{% endblock %}
{% block content %}

<div class="container-fluid mt-4 px-3">

  <!-- ğŸ”¹ Header -->
  <h4 class="fw-bold mb-3">ğŸ“‹ Data Pemeliharaan Alat Kesehatan</h4>

<!-- ğŸ” Filter Tahun + Search + Tombol Import & Export -->
<div class="card shadow-sm p-3 mb-4 border-0">

  <!-- Bagian atas dibagi jadi dua sisi (flex): kiri dan kanan -->
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-0">

    <!-- ğŸ”¹ Kiri: Tahun + Pencarian -->
    <form method="get" class="d-flex align-items-center flex-wrap gap-2" style="flex: 1; min-width: 600px;">
      <label for="tahun" class="fw-semibold mb-0">Tahun:</label>
      <select id="tahun" name="tahun" class="form-select form-select-sm"
              style="width: 110px; height: 38px;"
              onchange="this.form.submit()">
        {% for t in range(2020, 2031) %}
          <option value="{{ t }}" {% if t == tahun|int %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>

      <div class="d-flex align-items-center" style="gap: 6px;">
        <div class="d-flex align-items-center border rounded px-2" style="height: 38px;">
          <span class="me-2">ğŸ”</span>
          <input type="text" name="q" value="{{ q }}" class="form-control border-0 p-0"
                 style="box-shadow:none; height: 36px; width: 320px;"
                 placeholder="Cari nama alat, merk, tipe, SN, ruangan, kondisi...">
        </div>
        <button class="btn btn-success" type="submit" style="height: 38px;">Cari</button>
        <a href="{{ url_for('admin_maintenance', tahun=tahun) }}"
           class="btn btn-secondary" style="height: 38px;">Reset</a>
      </div>
    </form>

    <!-- ğŸ”¹ Kanan: Tombol Import & Export sejajar -->
    <div class="d-flex align-items-center flex-wrap gap-2">
      <form action="{{ url_for('import_maintenance_data', tahun_asal=(tahun|int - 1), tahun_tujuan=(tahun|int)) }}"
            method="post"
            onsubmit="return confirm('Import data pemeliharaan dari tahun {{ tahun|int - 1 }} ke {{ tahun }}?');">
        <button type="submit" class="btn btn-info btn-sm" style="height: 38px;">ğŸ“‚ Import dari {{ tahun|int - 1 }}</button>
      </form>

      <a href="{{ url_for('export_maintenance_excel', tahun=tahun) }}"
         class="btn btn-success btn-sm" style="height: 38px;">ğŸ“Š Unduh Excel</a>
    </div>

  </div>
</div>

  </form>


</div> <!-- âœ… Tutup card di sini -->


<!-- ğŸ§° Form Tambah Data -->
<div class="card p-3 mb-4 shadow-sm border-0 w-100">
  <h5 class="fw-semibold mb-3">ğŸ› ï¸ Tambah Data Pemeliharaan</h5>

  <form method="POST" action="{{ url_for('add_maintenance') }}" enctype="multipart/form-data" class="row g-3">
    <!-- Identitas alat -->
    <div class="col-md-4">
      <label class="form-label">Nama Alat</label>
      <input type="text" name="nama_alat" class="form-control" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Merk</label>
      <input type="text" name="merk" class="form-control" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Tipe</label>
      <input type="text" name="tipe" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">SN</label>
      <input type="text" name="sn" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Ruangan</label>
      <input type="text" name="ruangan" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Kondisi Alat</label>
      <select name="kondisi" class="form-select" required>
        <option value="Baik">Baik</option>
        <option value="Perlu Perbaikan">Perlu Perbaikan</option>
        <option value="Rusak">Rusak</option>
      </select>
    </div>

    <hr class="mt-4 mb-2">

    <!-- PERIODE 1 -->
<div class="col-12 fw-semibold text-success mt-3">ğŸ—“ï¸ Periode 1</div>
<div class="d-flex align-items-center flex-wrap gap-3 mb-2">
  <div style="width: 220px;">
    <label class="form-label mb-1 small">Tanggal Pemeliharaan</label>
    <input type="date" name="tgl_periode1" class="form-control form-control-sm">
  </div>
  <div style="flex: 1; max-width: 500px;">
    <label class="form-label mb-1 small">Upload File Pemeliharaan</label>
    <input type="file" name="file_periode1" class="form-control form-control-sm" accept=".pdf,.jpg,.png,.jpeg">
  </div>
</div>

<!-- PERIODE 2 -->
<div class="col-12 fw-semibold text-primary mt-2">ğŸ—“ï¸ Periode 2</div>
<div class="d-flex align-items-center flex-wrap gap-3 mb-2">
  <div style="width: 220px;">
    <label class="form-label mb-1 small">Tanggal Pemeliharaan</label>
    <input type="date" name="tgl_periode2" class="form-control form-control-sm">
  </div>
  <div style="flex: 1; max-width: 500px;">
    <label class="form-label mb-1 small">Upload File Pemeliharaan</label>
    <input type="file" name="file_periode2" class="form-control form-control-sm" accept=".pdf,.jpg,.png,.jpeg">
  </div>
</div>

<!-- PERIODE 3 -->
<div class="col-12 fw-semibold text-warning mt-2">ğŸ—“ï¸ Periode 3</div>
<div class="d-flex align-items-center flex-wrap gap-3 mb-2">
  <div style="width: 220px;">
    <label class="form-label mb-1 small">Tanggal Pemeliharaan</label>
    <input type="date" name="tgl_periode3" class="form-control form-control-sm">
  </div>
  <div style="flex: 1; max-width: 500px;">
    <label class="form-label mb-1 small">Upload File Pemeliharaan</label>
    <input type="file" name="file_periode3" class="form-control form-control-sm" accept=".pdf,.jpg,.png,.jpeg">
  </div>
</div>

<!-- Tombol Simpan -->
<div class="col-12 mt-3 text-start">
  <button type="submit" class="btn btn-success px-4">
    ğŸ’¾ Simpan Data
  </button>
</div>
</form> <!-- âœ… Tutup form tambah data -->


  <!-- ğŸ“‹ Tabel -->
  <div class="table-responsive shadow-sm rounded bg-white p-2 w-100">
  <table class="table table-bordered table-striped align-middle mb-0 text-center">
<thead class="table-success align-middle text-center">
  <tr>
    <th rowspan="2" class="align-middle text-center">No</th>
    <th rowspan="2" class="align-middle text-center">Nama Alat</th>
    <th rowspan="2" class="align-middle text-center">Merk</th>
    <th rowspan="2" class="align-middle text-center">Tipe</th>
    <th rowspan="2" class="align-middle text-center">SN</th>
    <th rowspan="2" class="align-middle text-center">Ruangan</th>
    <th colspan="3" class="align-middle text-center">Tgl Pemeliharaan</th>
    <th rowspan="2" class="align-middle text-center">Kondisi</th>
    <th rowspan="2" class="align-middle text-center">Berkas</th>
    <th rowspan="2" class="align-middle text-center">Aksi</th>
  </tr>
  <tr>
    <th class="align-middle text-center">Periode 1</th>
    <th class="align-middle text-center">Periode 2</th>
    <th class="align-middle text-center">Periode 3</th>
  </tr>
</thead>


<tbody>
  {% for r in records %}
  <tr>
    <td class="text-center">{{ loop.index }}</td>
    <td>{{ r.nama_alat }}</td>
    <td>{{ r.merk }}</td>
    <td>{{ r.tipe }}</td>
    <td>{{ r.sn }}</td>
    <td>{{ r.ruangan }}</td>

    <!-- tanggal per periode -->
    <td class="text-center">{{ r.tgl_periode1 or '-' }}</td>
    <td class="text-center">{{ r.tgl_periode2 or '-' }}</td>
    <td class="text-center">{{ r.tgl_periode3 or '-' }}</td>

    <td class="text-center">{{ r.kondisi or '-' }}</td>

    <!-- tombol lihat file per periode -->
    <td class="text-center">
  {% if r.file_periode1 %}
    <a href="{{ url_for('static', filename=r.file_periode1) }}" 
       target="_blank" rel="noopener noreferrer"
       class="btn btn-outline-primary btn-sm">P1</a>
  {% else %}
    <span class="text-muted">-</span>
  {% endif %}

  {% if r.file_periode2 %}
    <a href="{{ url_for('static', filename=r.file_periode2) }}" 
       target="_blank" rel="noopener noreferrer"
       class="btn btn-outline-success btn-sm ms-1">P2</a>
  {% else %}
    <span class="text-muted">-</span>
  {% endif %}

  {% if r.file_periode3 %}
    <a href="{{ url_for('static', filename=r.file_periode3) }}" 
       target="_blank" rel="noopener noreferrer"
       class="btn btn-outline-warning btn-sm ms-1">P3</a>
  {% else %}
    <span class="text-muted">-</span>
  {% endif %}
</td>


    <td class="text-center">
      <a href="{{ url_for('admin_maintenance_edit', mid=r.id) }}" class="btn btn-warning btn-sm">âœï¸</a>
      <form action="{{ url_for('admin_maintenance_delete', mid=r.id) }}" method="post" class="d-inline"
            onsubmit="return confirm('Hapus data ini?');">
        <button class="btn btn-danger btn-sm">ğŸ—‘ï¸</button>
      </form>
    </td>
  </tr>
  {% endfor %}
</tbody>


  </table>
</div>


  <!-- ğŸ“„ Pagination -->
  {% if total_pages > 1 %}
  <nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center mb-0">
      <li class="page-item {% if page <= 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('admin_maintenance', page=page-1, tahun=tahun, q=q) }}">â€¹ Prev</a>
      </li>
      {% for p in range(1, total_pages + 1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('admin_maintenance', page=p, tahun=tahun, q=q) }}">{{ p }}</a>
      </li>
      {% endfor %}
      <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('admin_maintenance', page=page+1, tahun=tahun, q=q) }}">Next â€º</a>
      </li>
    </ul>
  </nav>
  {% endif %}

</div>

{% endblock %}
